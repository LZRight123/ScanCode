//
//  ScanViewController.m
//  Ibeauty
//
//  Created by sean on 15/4/2.
//  Copyright (c) 2015å¹´ sean. All rights reserved.
//

#import "ScanViewController.h"
#import <AVFoundation/AVFoundation.h>

#define Screen_Width [UIScreen mainScreen].bounds.size.width
#define Screen_Height [UIScreen mainScreen].bounds.size.height
#define Code_Size CGSizeMake((Screen_Width-60), (Screen_Width-60))
#define Corner_Width 20.f
#define Corner_Border_Width 2.f
#define Border_Width 0.5f

@interface ScanViewController () <AVCaptureMetadataOutputObjectsDelegate>
@property (nonatomic,strong) AVCaptureDevice * device;
@property (strong, nonatomic ) AVCaptureSession * session;
@property (strong, nonatomic ) AVCaptureVideoPreviewLayer * preview;
@property (strong, nonatomic) AVCaptureMetadataOutput *outPutView;
/**
 *  è¾¹æ¡†
 */
@property (strong, nonatomic) UIView *scanCropView;
/**
 *  æ‰«æçº¿
 */
@property (strong, nonatomic) UIView *line;
/**
 *  æ‰«æåŒºåŸŸ
 */
@property (assign, nonatomic) CGRect readerViewFrame;
/**
 *  èƒŒæ™¯å›¾
 */
@property (strong, nonatomic) UIView *backgroundView;
/**
 *  æ˜¯äºŒç»´ç è¿˜æ˜¯åˆ«çš„ æ¯”å¦‚æ¡å½¢ç 
 */
@property (assign, nonatomic) BOOL isQRCode;
/**
 *  æ˜¯å¦æ‰“å¼€é—ªå…‰ç¯
 */
@property (assign, nonatomic) BOOL  isOpenFlashlight;
/**
 *  æç¤ºlabel
 */
@property (strong, nonatomic) UILabel *tiShiView;
/**
 *  äºŒç»´ç æŒ‰é’®
 */
@property (strong, nonatomic) UIButton *QRCodeBtn;
/**
 *  æ¡å½¢ç ç æŒ‰é’®
 */
@property (strong, nonatomic) UIButton *BarCodeBtn;
@end

@implementation ScanViewController {

    NSTimer *_lineTimer;
}

- (instancetype)init {

    self = [super init];

    if (self) {
        
        self.view.backgroundColor = [UIColor blackColor];
    }
    
    return self;
}

- (void)viewDidLoad {
    
    [super viewDidLoad];

    self.title = @"æ‰«æäºŒç»´ç ";

    // ç»™ä»¥åçš„è§†å›¾è®¾ç½®frameï¼›
    self.readerViewFrame = CGRectMake((Screen_Width - Code_Size.width) / 2,(Screen_Height - Code_Size.height) / 2-30, Code_Size.width, Code_Size.height);
    [self initUI];
    [self setOverlayView];
    [self startLineScanning];
}

#pragma mark - Private Method

- (void)initUI {
    //init
    self.device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];
    //input
    AVCaptureDeviceInput *input = [AVCaptureDeviceInput deviceInputWithDevice:self.device error:nil];
    //output
//    AVCaptureMetadataOutput *output = [[AVCaptureMetadataOutput alloc] init];
    self.outPutView = [[AVCaptureMetadataOutput alloc] init];
    [self.outPutView setMetadataObjectsDelegate:self queue:dispatch_get_main_queue()];
    [self.outPutView setRectOfInterest:[self setReaderViewSize]];
    //session
    _session = [[AVCaptureSession alloc] init];
    [_session setSessionPreset:AVCaptureSessionPresetHigh];
    if ([_session canAddInput:input]) {
        
        [_session addInput:input];
    }
    if ([_session canAddOutput:self.outPutView]) {
        
        [_session addOutput:self.outPutView];
    }
    
    // è®¾å¤‡æƒ…å†µ
    if (!TARGET_IPHONE_SIMULATOR){
        //æ¡ç ç±»å‹
        self.outPutView.metadataObjectTypes = @[AVMetadataObjectTypeQRCode,AVMetadataObjectTypeCode39Code,AVMetadataObjectTypeCode128Code,AVMetadataObjectTypeCode39Mod43Code,AVMetadataObjectTypeEAN13Code,AVMetadataObjectTypeEAN8Code,AVMetadataObjectTypeCode93Code];
    }
   
    
    
    //preview
    _preview = [AVCaptureVideoPreviewLayer layerWithSession:_session];
    _preview.videoGravity = AVLayerVideoGravityResizeAspectFill;
    _preview.frame = self.view.layer.bounds;
    [self.view.layer insertSublayer:_preview above:0];
}
/**
 *  è¯»å–æ¡†çš„frame
 */
- (CGRect)setReaderViewSize {
    return CGRectMake(self.readerViewFrame.origin.y/Screen_Height, self.readerViewFrame.origin.x/Screen_Width,Code_Size.height / Screen_Height, Code_Size.width / Screen_Width);
}
-(void) setReaderViewFrame:(CGRect)readerViewFrame{
    _readerViewFrame = readerViewFrame;
    [self.view.subviews makeObjectsPerformSelector:@selector(removeFromSuperview)];
    [self setOverlayView];
    [self.outPutView setRectOfInterest:[self setReaderViewSize]];

}
- (void)setOverlayView {
    //èƒŒæ™¯
    UIView *shadowView = [[UIView alloc] initWithFrame:self.view.bounds];
    shadowView.backgroundColor = [UIColor colorWithWhite:0.f alpha:.7f];
    self.backgroundView = shadowView;
    [self setupCustomView];
    [self.view addSubview:shadowView];
    
    
    //è¯»å–äºŒç»´ç åŒºåŸŸ
    UIBezierPath *path = [UIBezierPath bezierPathWithRect:shadowView.bounds];
    [path appendPath:[[UIBezierPath bezierPathWithRect:self.readerViewFrame] bezierPathByReversingPath]];
    CAShapeLayer *shapeLayer = [CAShapeLayer layer];
    shapeLayer.backgroundColor = [UIColor redColor].CGColor;
    shapeLayer.path = path.CGPath;
    [shadowView.layer setMask:shapeLayer];
    
    /**
      * self.readerViewFrame çš„åæ ‡
     */
    CGFloat x = self.readerViewFrame.origin.x;
    CGFloat y = self.readerViewFrame.origin.y;
    CGFloat w = self.readerViewFrame.size.width;
    CGFloat h = self.readerViewFrame.size.height;
    
    //åŸºå‡†çº¿
    _line = [[UIView alloc] initWithFrame:CGRectMake(x ,y, w, 1.5)];
    _line.backgroundColor = [UIColor redColor];
    [self.view addSubview:_line];
    
    //è¾¹æ¡†
    _scanCropView = [[UIView alloc] initWithFrame:CGRectMake(x - Border_Width,y - Border_Width,w + Border_Width * 2, h + Border_Width * 2)];
    _scanCropView.layer.borderColor = [UIColor whiteColor].CGColor;
    _scanCropView.layer.borderWidth = Border_Width;
    [shadowView addSubview:_scanCropView];

    //å››ä¸ªè§’
    //å·¦ä¸Š
    UIBezierPath *topLeftCornerPath = [UIBezierPath new];
    CAShapeLayer *topLeftLayer = [CAShapeLayer new];
    [self setCornerBorder:topLeftLayer];
    [topLeftCornerPath moveToPoint:CGPointMake(0, Corner_Width)];
    [topLeftCornerPath addLineToPoint:CGPointMake(0, 0)];
    [topLeftCornerPath addLineToPoint:CGPointMake(Corner_Width, 0)];
    topLeftLayer.path = topLeftCornerPath.CGPath;
    [self setCorderBounds:topLeftLayer];
    CGPoint point = CGPointMake(Corner_Width / 2 - Border_Width - Border_Width, Corner_Width / 2 - Corner_Border_Width / 2);
    topLeftLayer.position = point;
    [_scanCropView.layer addSublayer:topLeftLayer];

    //å³ä¸Š
    UIBezierPath *topRightCornerPath = [UIBezierPath new];
    CAShapeLayer *topRightLayer = [CAShapeLayer new];
    [self setCornerBorder:topRightLayer];
    [topRightCornerPath moveToPoint:CGPointMake(0, 0)];
    [topRightCornerPath addLineToPoint:CGPointMake(Corner_Width, 0)];
    [topRightCornerPath addLineToPoint:CGPointMake(Corner_Width, Corner_Width)];
    topRightLayer.path = topRightCornerPath.CGPath;
    [self setCorderBounds:topRightLayer];
    point = CGPointMake(_scanCropView.frame.size.width - Corner_Width / 2 + Corner_Border_Width / 2, Corner_Width / 2 - Corner_Border_Width / 2);
    topRightLayer.position = point;
    [_scanCropView.layer addSublayer:topRightLayer];
    
    //å·¦ä¸‹
    UIBezierPath *bottomLeftCornerPath = [UIBezierPath new];
    CAShapeLayer *bottomLeftLayer = [CAShapeLayer new];
    [self setCornerBorder:bottomLeftLayer];
    [bottomLeftCornerPath moveToPoint:CGPointMake(0, 0)];
    [bottomLeftCornerPath addLineToPoint:CGPointMake(0, Corner_Width)];
    [bottomLeftCornerPath addLineToPoint:CGPointMake(Corner_Width, Corner_Width)];
    bottomLeftLayer.path = bottomLeftCornerPath.CGPath;
    [self setCorderBounds:bottomLeftLayer];
    point = CGPointMake(Corner_Width / 2 - Border_Width - Border_Width, _scanCropView.frame.size.height - Corner_Width / 2 + Corner_Border_Width / 2);
    bottomLeftLayer.position = point;
    [_scanCropView.layer addSublayer:bottomLeftLayer];
    
    //å³ä¸‹
    UIBezierPath *bottomRightCornerPath = [UIBezierPath new];
    CAShapeLayer *bottomRightLayer = [CAShapeLayer new];
    [self setCornerBorder:bottomRightLayer];
    [bottomRightCornerPath moveToPoint:CGPointMake(Corner_Width, 0)];
    [bottomRightCornerPath addLineToPoint:CGPointMake(Corner_Width, Corner_Width)];
    [bottomRightCornerPath addLineToPoint:CGPointMake(0, Corner_Width)];
    bottomRightLayer.path = bottomRightCornerPath.CGPath;
    [self setCorderBounds:bottomRightLayer];
    point = CGPointMake(_scanCropView.frame.size.width - Corner_Width / 2 + Corner_Border_Width / 2, _scanCropView.frame.size.height - Corner_Width / 2 + Corner_Border_Width / 2);
    bottomRightLayer.position = point;
    [_scanCropView.layer addSublayer:bottomRightLayer];
    
    
    //è¯´æ˜label
    UILabel *labIntroudction = [[UILabel alloc] init];
    labIntroudction.backgroundColor = [UIColor clearColor];
    labIntroudction.frame = CGRectMake(_scanCropView.frame.origin.x, CGRectGetMaxY(_scanCropView.frame)+ 30.f, _scanCropView.frame.size.width, 20.f);
    labIntroudction.textAlignment = NSTextAlignmentCenter;
    labIntroudction.font = [UIFont boldSystemFontOfSize:16.0];
    labIntroudction.textColor = [UIColor whiteColor];
    labIntroudction.text = @"å°†äºŒç»´ç ç½®äºæ¡†å†…,å³å¯è‡ªåŠ¨æ‰«æ";
    [self.view addSubview:labIntroudction];
    self.tiShiView = labIntroudction;
}

- (void)setCorderBounds:(CAShapeLayer *)layer {

    CGPathRef bound = CGPathCreateCopyByStrokingPath(layer.path, nil, layer.lineWidth, kCGLineCapButt, kCGLineJoinMiter, layer.miterLimit);
    layer.bounds = CGPathGetBoundingBox(bound);
    CGPathRelease(bound);
}

- (void)setCornerBorder:(CAShapeLayer *)layer {
    
    layer.lineWidth = Corner_Border_Width;
    layer.strokeColor = [UIColor greenColor].CGColor;
    layer.fillColor = [UIColor clearColor].CGColor;
}

#pragma mark - Actions

- (void)startLineScanning {

    _lineTimer = [NSTimer scheduledTimerWithTimeInterval:1.0f / 20 target:self selector:@selector(animationLine) userInfo:nil repeats:YES];
    
    [_session startRunning];
}

- (void)stopLineScanning {

    if (_lineTimer)
    {
        [_lineTimer invalidate];
        _lineTimer = nil;
    }
    
    [_session stopRunning];
}

#pragma mark - Private Method

- (void)createGradient:(UIView *)view {

    //TODO
}

static BOOL flag = YES;

- (void)animationLine {

    __block CGRect frame = _line.frame;
    
    if (flag)
    {
        frame.origin.y = _scanCropView.frame.origin.y;
        flag = NO;
        
        [UIView animateWithDuration:1.0 / 20 animations:^{
            
            frame.origin.y += 5;
            _line.frame = frame;
            
        } completion:nil];
    }
    else
    {
        if (_line.frame.origin.y >= _scanCropView.frame.origin.y)
        {
            if (_line.frame.origin.y >= _scanCropView.frame.origin.y + _scanCropView.frame.size.height - _line.frame.size.height)
            {
                frame.origin.y = _scanCropView.frame.origin.y;
                _line.frame = frame;
                
                flag = YES;
            }
            else
            {
                [UIView animateWithDuration:1.0 / 20 animations:^{
                    
                    frame.origin.y += 5;
                    _line.frame = frame;
                    
                } completion:nil];
            }
        }
        else
        {
            flag = !flag;
        }
    }
}
-(BOOL) prefersStatusBarHidden{
    return YES;
}
#pragma mark - AVCaptureMetadataOutputObjectsDelegate

- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputMetadataObjects:(NSArray *)metadataObjects fromConnection:(AVCaptureConnection *)connection {

    NSString *stringValue;
    if (metadataObjects.count > 0 )
    {
        // åœæ­¢æ‰«æ
        [self stopLineScanning];
        AVMetadataMachineReadableCodeObject * metadataObject = [metadataObjects objectAtIndex:0];
        NSArray *stringArray = [metadataObject.stringValue componentsSeparatedByString:@","];
        stringValue = [stringArray lastObject];
        NSLog(@"%@",metadataObject);
        [self dismissViewControllerAnimated:YES completion:nil];
        if ([self.delegate respondsToSelector:@selector(scanView:didScanedCode:)]) {
             [self.delegate scanView:self didScanedCode:stringValue];
        }
       
    }
}
#pragma mark  è‡ªå®šä¹‰å›¾å±‚
-(void) setupCustomView{
    CGRect frame = self.backgroundView.frame;
//    self.backgroundView  æ³¨æ„å°ºå¯¸å³å¯
    //1...è¿”å›é”®
    UIButton  *backBtn = [[UIButton alloc]initWithFrame:CGRectMake(30, 25, 35, 35)];
    [backBtn setBackgroundImage:[UIImage imageNamed:@"01"] forState:UIControlStateNormal];
    [backBtn addTarget:self action:@selector(clickBackBtn) forControlEvents:UIControlEventTouchUpInside];
    [self.backgroundView addSubview:backBtn];
    
    //2....æ‰‹ç”µç­’ ğŸ”¦
    UIButton  *flashlightBtn = [[UIButton alloc]initWithFrame:CGRectMake(frame.size.width - 35 -30, 25, 35, 35)];
    [flashlightBtn setBackgroundImage:[UIImage imageNamed:@"03"] forState:UIControlStateNormal];
    [flashlightBtn addTarget:self action:@selector(clickFlashlightBtn) forControlEvents:UIControlEventTouchUpInside];
    [self.backgroundView addSubview:flashlightBtn];
    
    //å·¥å…·æ¡èƒŒæ™¯
    UIView *toolBar = [[UIView alloc] initWithFrame:CGRectMake(frame.origin.x, frame.size.height - 54, frame.size.width, 54)];
    toolBar.backgroundColor = [UIColor colorWithRed:0 green:0 blue:0 alpha:0.7];
    
    UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 45, 45)];
    [btn setBackgroundImage:[UIImage imageNamed:@"3"] forState:UIControlStateNormal];
    [btn setBackgroundImage:[UIImage imageNamed:@"3-1"] forState:UIControlStateSelected];
    btn.selected = YES;
    btn.center = CGPointMake((frame.size.width*0.5-45)*0.5, CGRectGetHeight(toolBar.frame)*0.5);
    [btn addTarget:self action:@selector(QRCodeFrameTransform:) forControlEvents:UIControlEventTouchUpInside];
    [toolBar addSubview:btn];
    self.QRCodeBtn = btn;
    
    UIButton *btn2 = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 45, 45)];
    [btn2 setBackgroundImage:[UIImage imageNamed:@"02"] forState:UIControlStateNormal];
    [btn2 setBackgroundImage:[UIImage imageNamed:@"02-1"] forState:UIControlStateSelected];
    btn2.center = CGPointMake((frame.size.width*0.5+45+frame.size.width)*0.5, CGRectGetHeight(toolBar.frame)*0.5);
    [btn2 addTarget:self action:@selector(barCodeFrameTransform:) forControlEvents:UIControlEventTouchUpInside];
    [toolBar addSubview:btn2];
    self.BarCodeBtn = btn2;
    
//    [self.backgroundView addSubview:toolBar];
    
}
/**
 *  ç‚¹å‡»è¿”å›æŒ‰é’®
 */
-(void) clickBackBtn{
    [self dismissViewControllerAnimated:YES completion:nil];
    [self stopFlashlight];
}
/**
 *  æ‰‹ç”µç­’ ğŸ”¦
 */
-(void) clickFlashlightBtn{
    if (!self.isOpenFlashlight) { //å¼€é—ªå…‰ç¯
        self.isOpenFlashlight = YES;
        if([self.device hasTorch] && [self.device hasFlash])
        {
            if(self.device.torchMode == AVCaptureTorchModeOff)
            {
                [self.session beginConfiguration];
                [self.device lockForConfiguration:nil];
                [self.device setTorchMode:AVCaptureTorchModeOn];
                [self.device setFlashMode:AVCaptureFlashModeOn];
                [self.device unlockForConfiguration];
                [self.session commitConfiguration];
            }
        }
        [self.session startRunning];
    }else{
        [self stopFlashlight];
//        [self.session stopRunning];
      
    }
}
-(void) stopFlashlight{
    self.isOpenFlashlight = NO;
    [self.session beginConfiguration];
    [self.device lockForConfiguration:nil];
    if(self.device.torchMode == AVCaptureTorchModeOn)
    {
        [self.device setTorchMode:AVCaptureTorchModeOff];
        [self.device setFlashMode:AVCaptureFlashModeOff];
    }
    [self.device unlockForConfiguration];
    [self.session commitConfiguration];
}
-(void) QRCodeFrameTransform:(UIButton*)sender{
   
    self.readerViewFrame = CGRectMake((Screen_Width - Code_Size.width) / 2,(Screen_Height - Code_Size.height) / 2-30, Code_Size.width, Code_Size.height);
    self.tiShiView.text = @"å°†äºŒç»´ç ç½®äºæ¡†å†…,å³å¯è‡ªåŠ¨æ‰«æ";
    self.QRCodeBtn.selected = YES;
    self.BarCodeBtn.selected = NO;
//    if (!self.isQRCode) {
//        self.isQRCode = YES;
//        self.QRCodeBtn.selected = NO;
//         CGFloat scale = 0.6;
//        self.readerViewFrame = CGRectMake((Screen_Width - Code_Size.width) / 2,(Screen_Height - Code_Size.height*scale) / 2  , Code_Size.width, Code_Size.height*scale);
//        self.tiShiView.text = @"å°†æ¡å½¢ç ç½®äºæ¡†å†…,å³å¯è‡ªåŠ¨æ‰«æ";
//    }else{
//        self.isQRCode = NO;
//        self.BarCodeBtn.selected = YES;
//        
//        self.readerViewFrame = CGRectMake((Screen_Width - Code_Size.width) / 2,(Screen_Height - Code_Size.height) / 2-30, Code_Size.width, Code_Size.height);
//        self.tiShiView.text = @"å°†äºŒç»´ç ç½®äºæ¡†å†…,å³å¯è‡ªåŠ¨æ‰«æ";
//    }
}
-(void) barCodeFrameTransform:(UIButton*)sender{
 
    CGFloat scale = 0.6;
    self.readerViewFrame = CGRectMake((Screen_Width - Code_Size.width) / 2,(Screen_Height - Code_Size.height*scale) / 2  , Code_Size.width, Code_Size.height*scale);
    self.tiShiView.text = @"å°†æ¡å½¢ç ç½®äºæ¡†å†…,å³å¯è‡ªåŠ¨æ‰«æ";
    
    self.QRCodeBtn.selected = NO;
    self.BarCodeBtn.selected = YES;
}
@end
